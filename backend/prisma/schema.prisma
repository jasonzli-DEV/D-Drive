// Prisma schema file for D-Drive database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  discordId     String   @unique
  username      String
  discriminator String
  avatar        String?
  email         String?
  encryptionKey String?  // Key for encrypting user files
  encryptByDefault Boolean  @default(true)
  recycleBinEnabled Boolean @default(true)  // Enable/disable recycle bin
  allowSharedWithMe Boolean @default(true)  // Allow others to share files with this user
  theme         String   @default("auto")  // Theme preference: light, dark, auto
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  files       File[]
  apiKeys     ApiKey[]
  sessions    Session[]
  tasks       Task[]
  logs        Log[]
  shares      Share[]    @relation("ShareOwner")
  sharedWithMe Share[]   @relation("ShareRecipient")
  publicLinks PublicLink[]
}

model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  lastUsed  DateTime?

  @@index([userId])
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model File {
  id          String   @id @default(uuid())
  name        String
  path        String
  size        BigInt   @default(0)
  mimeType    String?
  type        FileType @default(FILE)
  encrypted   Boolean  @default(false)
  starred     Boolean  @default(false)  // User-starred file for quick access
  parentId    String?
  parent      File?    @relation("FileHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    File[]   @relation("FileHierarchy")
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Recycle bin support
  deletedAt   DateTime?  // If set, file is in recycle bin
  originalPath String?   // Original path before deletion (for restore)
  deletedWithParentId String?  // If set, this item was deleted as part of parent deletion
  
  // Discord storage references
  chunks    FileChunk[]
  
  // Sharing
  shares      Share[]
  publicLinks PublicLink[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, path])
  @@index([userId])
  @@index([parentId])
  @@index([path])
  @@index([deletedAt])
  @@index([starred])
  @@index([deletedWithParentId])
}

model FileChunk {
  id              String   @id @default(uuid())
  fileId          String
  file            File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  chunkIndex      Int
  messageId       String
  channelId       String
  attachmentUrl   String
  size            Int
  createdAt       DateTime @default(now())

  @@unique([fileId, chunkIndex])
  @@index([fileId])
}

enum FileType {
  FILE
  DIRECTORY
}

enum CompressFormat {
  NONE
  ZIP
  TAR_GZ
}

model Task {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  enabled        Boolean  @default(true)
  priority       Int      @default(0)  // Lower number = higher priority (0 is highest)
  cron           String   // cron expression
  sftpHost       String
  sftpPort       Int      @default(22)
  sftpUser       String
  sftpPath       String   // remote path to pull from
  sftpPrivateKey String?  // optional, stored encrypted at rest in DB in future
  sftpPassword    String?  // optional password auth for SFTP
  authPassword    Boolean  @default(false) // attempt password auth
  authPrivateKey  Boolean  @default(true)  // attempt private key auth
  destinationId  String?  // local destination folder (File.id)
  destinationPath String? // original path to recreate if folder deleted
  compress       CompressFormat @default(NONE)
  compressFiles  Boolean  @default(true) // compress files vs folders
  timestampNames Boolean  @default(true)
  maxFiles       Int      @default(0) // 0 = unlimited
  encrypt        Boolean  @default(false) // whether to encrypt per user's settings
  skipPrescan    Boolean  @default(false) // skip pre-scan phase for faster start (no progress %)
  cacheScanSize  Boolean  @default(false) // cache/save scan size when skipPrescan is enabled
  excludePaths   String[] @default([]) // paths to exclude from backup (e.g., ["bluemap", "dynmap"])
  lastScanSize   BigInt?  // last known scan size (cached when cacheScanSize is enabled)
  lastRun        DateTime? // when task last completed
  lastStarted    DateTime? // when task last started running
  lastRuntime    Int?      // runtime in seconds of last run
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
}

model Log {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       LogType  // task, upload, copy, delete
  action     String   // "Task Started", "Task Completed", "Task Failed", "File Uploaded", "File Copied", "File Deleted"
  success    Boolean  @default(true)
  message    String?  // error message or details
  metadata   String?  // JSON string with additional context (file names, task names, etc.)
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

enum LogType {
  TASK
  UPLOAD
  COPY
  DELETE
}

// Permission levels for sharing
enum SharePermission {
  VIEW       // Can view/download files and open folders
  EDIT       // Can view/download + rename/upload/delete within shared folders
}

model Share {
  id            String   @id @default(uuid())
  fileId        String
  file          File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  ownerId       String   // User who owns the file
  owner         User     @relation("ShareOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  sharedWithId  String   // User the file is shared with
  sharedWith    User     @relation("ShareRecipient", fields: [sharedWithId], references: [id], onDelete: Cascade)
  permission    SharePermission @default(VIEW)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([fileId, sharedWithId])  // Can only share a file once with a user
  @@index([ownerId])
  @@index([sharedWithId])
  @@index([fileId])
}

model PublicLink {
  id        String    @id @default(uuid())
  slug      String    @unique           // Unique URL slug (e.g., "flying-truck")
  fileId    String
  file      File      @relation(fields: [fileId], references: [id])
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  expiresAt DateTime?                  // Optional expiration date
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([fileId])
  @@index([slug])
}
